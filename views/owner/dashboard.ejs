<%- include('../partials/header') %>
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-warning">üöó Qu·∫£n l√Ω Xe & ƒê∆°n H√†ng</h2>
    <a href="/owner/create-car" class="btn btn-success fw-bold">+ ƒêƒÉng Xe M·ªõi</a>
</div>

<div class="card">
    <div class="card-header bg-dark text-white">Danh s√°ch kh√°ch thu√™ xe c·ªßa t√¥i</div>
    <div class="card-body">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Xe</th>
                    <th>Kh√°ch h√†ng</th>
                    <th>Ng√†y thu√™</th>
                    <th>T·ªïng ti·ªÅn</th>
                    <th>Tr·∫°ng th√°i</th>
                    <th>Thao t√°c</th>
                </tr>
            </thead>
            <tbody id="ownerTable"></tbody>
        </table>
    </div>
</div>

<script>
    async function loadOwnerData() {
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');
        
        if (!user || user.role !== 'OWNER') {
            alert('B·∫°n kh√¥ng c√≥ quy·ªÅn truy c·∫≠p trang n√†y!');
            window.location.href = '/';
            return;
        }

        const res = await fetch(`/api/v1/bookings/owner/my-bookings?ownerId=${user._id}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });
        const bookings = await res.json();
        const table = document.getElementById('ownerTable');

        bookings.forEach(b => {
            const html = `
                <tr>
                    <td>${b.carId.name}</td>
                    <td>${b.userId.fullName}<br><small>${b.userId.phone}</small></td>
                    <td>${new Date(b.startDate).toLocaleDateString()} - ${new Date(b.endDate).toLocaleDateString()}</td>
                    <td>${b.totalPrice.toLocaleString()} ƒë</td>
                    <td><span class="badge bg-info">${b.status}</span></td>
                    <td>
                        ${b.status === 'PENDING' ? 
                            `<button class="btn btn-success btn-sm" onclick="approveBooking('${b._id}')">‚úÖ Duy·ªát ƒë∆°n</button>` 
                            : '<span class="text-muted">ƒê√£ x·ª≠ l√Ω</span>'}
                    </td>
                </tr>
            `;
            table.innerHTML += html;
        });
    }

    async function approveBooking(id) {
        if(!confirm('X√°c nh·∫≠n cho thu√™ xe?')) return;
        const token = localStorage.getItem('token');
        
        const res = await fetch(`/api/v1/bookings/${id}/confirm`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if(res.ok) {
            alert('ƒê√£ duy·ªát ƒë∆°n v√† t·∫°o h·ª£p ƒë·ªìng!');
            location.reload();
        } else {
            alert('L·ªói khi duy·ªát ƒë∆°n');
        }
    }

    loadOwnerData();
</script>
<%- include('../partials/footer') %>