<%- include('../partials/header') %>

<div class="mb-3">
    <a href="/" class="text-decoration-none text-muted">‚Üê Quay l·∫°i danh s√°ch</a>
</div>

<div class="card border-0 shadow-sm bg-white">
    <div class="card-body p-4"> <div class="row"> <div class="col-md-7 mb-4 mb-md-0">
                <img src="<%= car.image || 'https://via.placeholder.com/600x400' %>" 
                     class="img-fluid rounded w-100" 
                     style="object-fit: cover; max-height: 400px;" 
                     alt="<%= car.name %>">
            </div>

            <div class="col-md-5">
                <h2 class="fw-bold"><%= car.name %></h2>
                <h3 class="text-danger fw-bold my-3"><%= car.price.toLocaleString() %> ƒë/ng√†y</h3>
                
                <ul class="list-unstyled text-muted mb-4">
                    <li class="mb-2"><strong>Ch·ªß xe:</strong> <%= car.ownerId ? car.ownerId.fullName : 'H·ªá th·ªëng' %></li>
                    <li class="mb-2"><strong>M√¥ t·∫£:</strong> <%= car.description || 'Ch∆∞a c√≥ m√¥ t·∫£' %></li>
                </ul>
                
                <hr>

                <div class="bg-light p-3 rounded">
                    <h5 class="mb-3">üìÖ ƒê·∫∑t xe n√†y</h5>
                    <form id="bookingForm">
                        <input type="hidden" id="carId" value="<%= car._id %>">
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Ng√†y nh·∫≠n</label>
                            <input type="date" id="startDate" class="form-control" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label small fw-bold">Ng√†y tr·∫£</label>
                            <input type="date" id="endDate" class="form-control" required>
                        </div>
                        
                        <button type="submit" class="btn btn-success w-100 fw-bold py-2">X√ÅC NH·∫¨N ƒê·∫∂T</button>
                    </form>
                </div>
            </div>
            
        </div> </div>
</div>

<script>
    document.getElementById('bookingForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const user = JSON.parse(localStorage.getItem('user'));
        const token = localStorage.getItem('token');

        if (!user || !token) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t xe!');
            window.location.href = '/login';
            return;
        }

        const payload = {
            userId: user._id,
            carId: document.getElementById('carId').value,
            startDate: document.getElementById('startDate').value,
            endDate: document.getElementById('endDate').value
        };

        try {
            const res = await fetch('/api/v1/bookings', {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}` 
                },
                body: JSON.stringify(payload)
            });
            const data = await res.json();

            if (res.ok) {
                alert('üéâ ƒê·∫∑t xe th√†nh c√¥ng!');
                window.location.href = '/my-bookings';
            } else {
                alert(data.error || 'L·ªói ƒë·∫∑t xe');
            }
        } catch (err) { alert('L·ªói k·∫øt n·ªëi Server'); }
    });
</script>
<%- include('../partials/footer') %>